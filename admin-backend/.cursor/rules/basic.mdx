---
description: i18n-flow Admin Backend - Cursor Rules
globs:
alwaysApply: true
---

# i18n-flow Admin Backend - Cursor Rules

## 项目概述

这是一个用 Go 语言开发的国际化(i18n)管理后端服务，采用 Clean Architecture 架构模式，提供 RESTful API 用于管理翻译项目、语言和翻译内容。

## 技术栈

- **语言**: Go 1.23+
- **Web 框架**: Gin 1.9.1
- **ORM**: GORM 1.30.0 (MySQL)
- **缓存**: Redis
- **认证**: JWT + API Key
- **文档**: Swagger/OpenAPI
- **日志**: Zap + Lumberjack
- **热重载**: Air

## 项目架构

### 目录结构

```
admin-backend/
├── cmd/server/          # 应用程序入口点
├── internal/            # 私有应用代码
│   ├── api/            # API层 (handlers, middleware, routes, response)
│   ├── service/        # 业务逻辑层 (含缓存装饰器)
│   ├── domain/         # 领域层 (models, interfaces, errors)
│   ├── repository/     # 数据访问层
│   ├── container/      # 依赖注入容器
│   └── config/         # 配置管理
├── utils/              # 共享工具函数
├── docs/               # Swagger文档 (自动生成)
├── migrations/         # 数据库迁移
└── tests/              # 测试文件
```

### 架构模式

- **Clean Architecture**: 清晰的分层架构，依赖倒置
- **DDD**: 领域驱动设计，领域模型在 domain 包中
- **依赖注入**: 使用 Container 模式管理依赖
- **装饰器模式**: 缓存服务包装基础服务
- **工厂模式**: HandlerFactory 和 MiddlewareFactory

## 核心组件

### 领域模型

- `User`: 用户模型 (管理员)
- `Project`: 翻译项目
- `Language`: 支持的语言
- `Translation`: 翻译条目

### 服务层

- 基础服务: `UserService`, `ProjectService`, `LanguageService`, `TranslationService`
- 缓存服务: `CachedXXXService` (装饰器模式)
- 认证服务: `AuthService` (JWT 处理)
- 仪表板服务: `DashboardService`

### API 端点

- **认证**: `/api/login`, `/api/refresh`
- **项目管理**: `/api/projects/*`
- **语言管理**: `/api/languages/*`
- **翻译管理**: `/api/translations/*`
- **CLI 集成**: `/api/cli/*`
- **仪表板**: `/api/dashboard/stats`

## 开发规范

### 代码风格

- 使用 Go 标准格式化工具 `gofmt`
- 遵循 Go 命名约定 (驼峰命名)
- 接口名以-er 结尾 (如 Repository, Service)
- 错误处理使用自定义 AppError 类型

### 错误处理

- 使用结构化错误 `domain.AppError`
- 错误分类: `ErrorTypeValidation`, `ErrorTypeNotFound`, `ErrorTypeConflict`等
- 统一错误响应格式
- 支持错误链和上下文信息

### 数据库

- 使用 GORM 进行 ORM 映射
- 软删除支持 (`gorm.DeletedAt`)
- 数据库迁移通过 AutoMigrate
- 连接池优化配置
- 复合索引优化查询性能

### 缓存策略

- Redis 作为缓存后端
- 缓存键使用结构化命名
- 防缓存击穿 (互斥锁)
- 防缓存雪崩 (随机过期时间)
- 空值缓存防止缓存穿透

### 中间件

- 安全头设置
- 全局限流 (令牌桶算法)
- 请求日志记录
- JWT 认证
- API Key 认证 (CLI)
- 错误处理
- CORS 支持

## 配置管理

- 环境变量优先
- `.env`文件支持
- 配置验证 (安全性检查)
- 分类配置: DB, JWT, Redis, Log, CLI

## 开发工具

- **热重载**: 使用 Air (`air`命令)
- **API 文档**: Swagger UI (`/swagger/index.html`)
- **健康检查**: `/health`端点
- **日志**: 结构化日志，支持文件轮转

## 部署

- Docker 支持 (Dockerfile)
- 多阶段构建优化镜像大小
- 环境变量配置
- 健康检查端点

## 测试

- 单元测试在`tests/`目录
- 使用 testify 测试框架
- 覆盖率报告支持

## 安全特性

- JWT 令牌认证 (管理员)
- API Key 认证 (CLI 工具)
- 请求大小限制
- 速率限制
- 安全 HTTP 头
- 密码哈希 (bcrypt)

## 编码建议

1. **新增功能**: 遵循 Clean Architecture，先定义领域接口
2. **错误处理**: 使用 AppError，提供清晰的错误信息
3. **缓存**: 考虑是否需要缓存，使用装饰器模式
4. **测试**: 为新功能编写单元测试
5. **文档**: 使用 Swagger 注释生成 API 文档
6. **日志**: 使用结构化日志，包含请求 ID
7. **验证**: 使用 Gin 的 binding 进行输入验证

## 常用命令

```bash
# 开发模式 (热重载)
air

# 直接运行
go run cmd/server/main.go

# 生成Swagger文档
swag init -g cmd/server/main.go

# 运行测试
go test ./...

# 构建
go build -o i18n-flow cmd/server/main.go
```

## 环境要求

- Go 1.23+
- MySQL 8.0+
- Redis 6.0+
- 端口: 8080 (HTTP), 3306 (MySQL), 6379 (Redis)
